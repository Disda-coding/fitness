<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥èº«è¿½è¸ªå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3a86ff;
            --secondary: #ff006e;
            --accent: #8338ec;
            --dark: #111827;
            --darker: #0a0f1d;
            --card-bg: #1e293b;
        }
        
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background: radial-gradient(circle at top, var(--darker), var(--dark));
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .page { 
            display: none; 
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page.active { display: block; }
        
        /* å¤´éƒ¨æ ·å¼ */
        .app-header {
            text-align: center;
            padding: 1.5rem 1rem;
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .app-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 8px rgba(58, 134, 255, 0.2);
        }
        
        .app-subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(26, 32, 44, 0.8));
            border: 1px solid rgba(74, 85, 104, 0.3);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(74, 85, 104, 0.3);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center; /* æ·»åŠ å±…ä¸­ */
        }
        
        .card-title i {
            margin-right: 0.75rem;
            font-size: 1.3rem;
        }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* æ‰‹æœºç«¯æœ€å°å®½åº¦æ”¹ä¸º140px */
            gap: 1rem; /* ç¼©å°é—´éš™ä»¥é€‚åº”å°å±å¹• */
            margin-bottom: 2rem;
        }

        /* æ‰‹æœºç«¯ç‰¹å®šæ ·å¼ */
        @media (max-width: 640px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr); /* å›ºå®šä¸¤åˆ—å¸ƒå±€ */
            }
            
            /* è®©åŠ¨ä½œç®¡ç†å¡ç‰‡å•ç‹¬å æ®ä¸€è¡Œ */
            .muscle-card:nth-last-child(1) {
                grid-column: 1 / -1;
            }
            
            /* è°ƒæ•´å¡ç‰‡é«˜åº¦ä»¥é€‚åº”æ›´å°çš„å±å¹• */
            .muscle-card {
                height: 160px;
            }
            
            /* è°ƒæ•´å›¾æ ‡å’Œæ–‡å­—å¤§å° */
            .muscle-icon {
                font-size: 2.5rem;
            }
            
            .muscle-name {
                font-size: 1.2rem;
            }

            /* åŠ¨ä½œç®¡ç†é¡µé¢çš„æŒ‰é’®æ ·å¼ */
            #exercise-management-page .flex.gap-3 {
                flex-direction: column;
            }
            
            #exercise-management-page .flex.gap-3 > * {
                width: 100%;
            }
            
            #exercise-management-page .flex.gap-3 > button {
                margin-top: 0.5rem;
            }
        }

        /* å¹³æ¿å’Œæ¡Œé¢ç«¯ä¿æŒåŸæœ‰æ ·å¼ */
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            
            .muscle-card {
                height: 200px;
            }
            
            .muscle-icon {
                font-size: 3.5rem;
            }
            
            .muscle-name {
                font-size: 1.4rem;
            }
        }
        
        /* è‚Œè‚‰ç¾¤å¡ç‰‡ */
        .muscle-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            height: 200px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(26, 32, 44, 0.8));
            border: 1px solid rgba(74, 85, 104, 0.3);
        }
        
        .muscle-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--primary), var(--accent), var(--secondary));
            z-index: -1;
            border-radius: 18px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .muscle-card:hover::before {
            opacity: 1;
        }
        
        .muscle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .muscle-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }
        
        .muscle-card:hover .muscle-icon {
            transform: scale(1.1);
        }
        
        .muscle-name {
            font-size: 1.4rem;
            font-weight: 600;
            text-align: center;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), #5a9cff);
            color: white;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #2b78ff, #4a8cff);
            box-shadow: 0 6px 20px rgba(58, 134, 255, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, var(--accent), #9a5eff);
            color: white;
            box-shadow: 0 4px 15px rgba(131, 56, 236, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(90deg, #7327e6, #8847eb);
            box-shadow: 0 6px 20px rgba(131, 56, 236, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-action {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(74, 85, 104, 0.4);
            color: #cbd5e1;
        }
        
        .btn-action:hover {
            background: rgba(30, 41, 59, 1);
            border: 1px solid var(--primary);
            color: white;
        }
        
        /* è¡¨å•å…ƒç´  */
        input, select {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(74, 85, 104, 0.4);
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%; /* ç¡®ä¿å®½åº¦ä¸€è‡´ */
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 4px solid rgba(74, 85, 104, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ¨¡æ€æ¡† */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* éœ“è™¹æ•ˆæœ */
        .neon-text {
            text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(58, 134, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
        }

        /* åŠ¨ä½œç®¡ç†æ¨¡å—ä¸‹æ‹‰èœå•æ ·å¼ */
        #manage-muscle-select {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(74, 85, 104, 0.4);
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        #manage-muscle-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
        }
        
        /* åŠ¨ä½œç®¡ç†æ¨¡å—æ ‡é¢˜å±…ä¸­ */
        #exercise-management-page .card-header h2,
        #exercise-management-page h3 {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä¸»é¡µ -->
        <div id="home-page" class="page active">
            <div class="app-header">
                <h1 class="app-title">å¥èº«è¿½è¸ªå™¨</h1>
                <p class="app-subtitle">è®°å½•ä½ çš„æ¯ä¸€æ¬¡è®­ç»ƒï¼Œè§è¯èº«ä½“çš„å˜åŒ–</p>
            </div>
            
            <div class="grid-container">
                <div class="muscle-card" onclick="showTrainingPage('chest', 'èƒ¸éƒ¨è®­ç»ƒ')">
                    <div class="muscle-icon">ğŸ’ª</div>
                    <div class="muscle-name">èƒ¸ & ä¸‰å¤´</div>
                </div>
                
                <div class="muscle-card" onclick="showTrainingPage('back', 'èƒŒéƒ¨è®­ç»ƒ')">
                    <div class="muscle-icon">ğŸš€</div>
                    <div class="muscle-name">èƒŒ & äºŒå¤´</div>
                </div>
                
                <div class="muscle-card" onclick="showTrainingPage('shoulders', 'è‚©éƒ¨è®­ç»ƒ')">
                    <div class="muscle-icon">ğŸ‹ï¸</div>
                    <div class="muscle-name">è‚©éƒ¨è®­ç»ƒ</div>
                </div>
                
                <div class="muscle-card" onclick="showTrainingPage('legs', 'è…¿éƒ¨è®­ç»ƒ')">
                    <div class="muscle-icon">ğŸ¦µ</div>
                    <div class="muscle-name">è…¿ & æ ¸å¿ƒ</div>
                </div>
                
                <div class="muscle-card" onclick="showExerciseManagementPage()">
                    <div class="muscle-icon">âš™ï¸</div>
                    <div class="muscle-name">åŠ¨ä½œç®¡ç†</div>
                </div>
            </div>
            
     
        </div>

        <!-- è®­ç»ƒé¡µé¢ -->
        <div id="training-page" class="page">
            <div class="flex items-center mb-6">
                <button onclick="showHomePage()" class="btn btn-action mr-4">
                    <i class="fas fa-arrow-left mr-2"></i> è¿”å›
                </button>
                <h1 id="training-title" class="text-2xl font-bold text-white flex-grow text-center"></h1>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-dumbbell"></i> è®°å½•ä»Šæ—¥è®­ç»ƒ</h2>
                    </div>
                    
                    <div id="current-session-container" class="space-y-4 mb-4">
                        <!-- åŠ¨æ€å†…å®¹ -->
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mt-6">
                        <button onclick="addExerciseToSession()" class="btn btn-primary flex-1">
                            <i class="fas fa-plus mr-2"></i> æ·»åŠ æ–°åŠ¨ä½œ
                        </button>
                        <button id="save-session-button" onclick="saveSession()" class="btn btn-secondary flex-1">
                            <i class="fas fa-save mr-2"></i> å®Œæˆå¹¶ä¿å­˜
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-history"></i> å†å²è®°å½•</h2>
                    </div>
                    
                    <div id="history-container" class="space-y-4">
                        <div id="loader" class="hidden justify-center items-center py-8">
                            <div class="loader"></div>
                        </div>
                        <!-- å†å²è®°å½•å†…å®¹ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠ¨ä½œç®¡ç†é¡µé¢ -->
<!-- åŠ¨ä½œç®¡ç†é¡µé¢éƒ¨åˆ†ä»£ç  -->
<div id="exercise-management-page" class="page">
    <div class="flex items-center mb-6">
        <button onclick="showHomePage()" class="btn btn-action mr-4">
            <i class="fas fa-arrow-left mr-2"></i> è¿”å›
        </button>
        <h1 class="text-2xl font-bold text-white flex-grow text-center">åŠ¨ä½œç®¡ç†</h1>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-dumbbell"></i> é€‰æ‹©è‚Œè‚‰ç¾¤</h2>
            </div>
            
            <select id="manage-muscle-select" onchange="loadExercisesForManagement(this.value)" 
                    class="w-full mb-4 bg-gray-800 border border-gray-600 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-blue-400 text-white">
                <option value="">-- è¯·é€‰æ‹©è‚Œè‚‰ç¾¤ --</option>
                <option value="chest">èƒ¸ & ä¸‰å¤´</option>
                <option value="back">èƒŒ & äºŒå¤´</option>
                <option value="shoulders">è‚©éƒ¨</option>
                <option value="legs">è…¿ & æ ¸å¿ƒ</option>
            </select>
            
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-300 text-center">æ·»åŠ æ–°åŠ¨ä½œ</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-exercise-input" placeholder="æ–°åŠ¨ä½œåç§°" 
                           class="flex-1 bg-gray-800 border border-gray-600 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-blue-400 text-white">
                    <button onclick="addNewExercise()" class="btn btn-primary sm:w-auto w-full">
                        <i class="fas fa-plus mr-1"></i> æ·»åŠ 
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-list"></i> åŠ¨ä½œåˆ—è¡¨</h2>
            </div>
            
            <div id="exercise-list-container" class="space-y-3">
                <p class="text-gray-500 text-center py-8" id="no-exercises-message">
                    <i class="fas fa-info-circle mr-2"></i>è¯·é€‰æ‹©ä¸€ä¸ªè‚Œè‚‰ç¾¤
                </p>
                <div id="exercise-list-loader" class="hidden justify-center items-center py-8">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-white"></h3>
            <p id="modal-body" class="text-gray-300 mb-6"></p>
            <div class="text-right" id="modal-actions">
                <button id="modal-close" class="btn btn-primary">å¥½çš„</button>
            </div>
        </div>
    </div>

    <!-- JavaScriptéƒ¨åˆ†ä¿æŒä¸å˜ -->
    <script>
        const API_BASE_URL = '/api'; // åç«¯APIçš„åŸºç¡€URL
        let currentMuscleGroup = ''; // å½“å‰é€‰æ‹©çš„è‚Œè‚‰ç¾¤ (ç”¨äºè®­ç»ƒé¡µé¢)
        let currentManageMuscleGroup = ''; // å½“å‰é€‰æ‹©çš„è‚Œè‚‰ç¾¤ (ç”¨äºåŠ¨ä½œç®¡ç†é¡µé¢)
        let availableExercises = []; // å¯ç”¨çš„åŠ¨ä½œåˆ—è¡¨

        // --- æ¨¡æ€æ¡† (Modal) é€»è¾‘ ---
        const modal = document.getElementById('modal');
        const modalActions = document.getElementById('modal-actions'); // æ¨¡æ€æ¡†æŒ‰é’®å®¹å™¨

        // é»˜è®¤çš„"å¥½çš„"æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        function defaultModalClose() {
            modal.style.display = 'none';
            restoreDefaultModalButton(); // ç¡®ä¿æ¯æ¬¡å…³é—­åæ¢å¤é»˜è®¤æŒ‰é’®
        }
        // åˆå§‹è®¾ç½®é»˜è®¤å…³é—­æŒ‰é’®
        document.getElementById('modal-close').onclick = defaultModalClose;

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            modal.style.display = 'flex';
            restoreDefaultModalButton(); // ç¡®ä¿æ˜¾ç¤ºé€šçŸ¥æ—¶æ˜¯é»˜è®¤çš„"å¥½çš„"æŒ‰é’®
        }

        // ç”¨äºç¡®è®¤æ“ä½œçš„æ¨¡æ€æ¡†
        function showConfirmModal(title, message, onConfirmCallback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            
            modalActions.innerHTML = ''; // æ¸…ç©ºæ‰€æœ‰æŒ‰é’®

            // æ·»åŠ "å–æ¶ˆ"æŒ‰é’®
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-action mr-3';
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.onclick = defaultModalClose; // ç‚¹å‡»å–æ¶ˆå…³é—­æ¨¡æ€æ¡†å¹¶æ¢å¤é»˜è®¤æŒ‰é’®
            modalActions.appendChild(cancelButton);

            // æ·»åŠ "ç¡®å®š"æŒ‰é’®
            const confirmButton = document.createElement('button');
            confirmButton.className = 'btn btn-secondary';
            confirmButton.textContent = 'ç¡®å®š';
            confirmButton.onclick = () => {
                defaultModalClose(); // å…³é—­æ¨¡æ€æ¡†å¹¶æ¢å¤é»˜è®¤æŒ‰é’®
                onConfirmCallback(); // æ‰§è¡Œç¡®è®¤å›è°ƒ
            };
            modalActions.appendChild(confirmButton);

            modal.style.display = 'flex';
        }

        // æ¢å¤æ¨¡æ€æ¡†åˆ°é»˜è®¤çš„"å¥½çš„"æŒ‰é’®çŠ¶æ€
        function restoreDefaultModalButton() {
            modalActions.innerHTML = ''; // æ¸…ç©ºæ‰€æœ‰è‡ªå®šä¹‰æŒ‰é’®
            const defaultOkButton = document.createElement('button');
            defaultOkButton.id = 'modal-close';
            defaultOkButton.className = 'btn btn-primary';
            defaultOkButton.textContent = 'å¥½çš„';
            defaultOkButton.onclick = defaultModalClose;
            modalActions.appendChild(defaultOkButton);
        }


        // --- é¡µé¢å¯¼èˆªé€»è¾‘ ---
        const pages = document.querySelectorAll('.page');
        function showPage(pageId) {
            pages.forEach(page => page.classList.toggle('active', page.id === pageId));
        }

        function showHomePage() {
            showPage('home-page'); // æ˜¾ç¤ºä¸»é¡µ
            // å½“è¿”å›ä¸»é¡µæ—¶ï¼Œæ¸…é™¤å½“å‰è®­ç»ƒçš„LocalStorageæ•°æ®ï¼Œå› ä¸ºå®ƒä¸å†æ˜¯"æœªå®Œæˆ"çš„çŠ¶æ€
            localStorage.removeItem(`currentSessionData_${currentMuscleGroup}`);
            // æ¸…ç©ºåŠ¨ä½œç®¡ç†é¡µé¢çš„é€‰æ‹©
            document.getElementById('manage-muscle-select').value = '';
        }

        async function showTrainingPage(muscle, title) {
            currentMuscleGroup = muscle; // è®¾ç½®å½“å‰è‚Œè‚‰ç¾¤
            document.getElementById('training-title').textContent = title; // è®¾ç½®é¡µé¢æ ‡é¢˜
            document.getElementById('current-session-container').innerHTML = ''; // æ¸…ç©ºå½“å‰è®­ç»ƒå®¹å™¨
            showPage('training-page'); // æ˜¾ç¤ºè®­ç»ƒé¡µé¢
            
            // 1. åŠ è½½å¯ç”¨åŠ¨ä½œåˆ—è¡¨
            await loadAvailableExercises();
            // 2. æ›´æ–°æ‰€æœ‰åŠ¨ä½œä¸‹æ‹‰èœå•
            updateAllExerciseDropdowns(); 

            // 3. å°è¯•ä»LocalStorageåŠ è½½ä¸Šæ¬¡æœªå®Œæˆçš„ä¼šè¯
            if (!await loadSessionFromLocalStorage()) {
                // å¦‚æœLocalStorageä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„ç©ºè®­ç»ƒåŠ¨ä½œ
                addExerciseToSession(); 
            }
            
            // 4. åŠ è½½å†å²è®°å½•
            await loadHistory();
        }

        async function showExerciseManagementPage() {
            showPage('exercise-management-page');
            // æ¯æ¬¡è¿›å…¥ç®¡ç†é¡µé¢æ—¶ï¼Œæ¸…é™¤ä¸Šæ¬¡é€‰æ‹©çš„è‚Œè‚‰ç¾¤ï¼Œå¹¶é‡ç½®åˆ—è¡¨
            document.getElementById('manage-muscle-select').value = '';
            // ç¡®ä¿åœ¨é‡ç½®å†…å®¹æ—¶ï¼Œloaderå…ƒç´ ä¸è¢«ç§»é™¤ï¼Œæˆ–è€…åœ¨éœ€è¦æ—¶é‡æ–°æ’å…¥
            const exerciseListContainer = document.getElementById('exercise-list-container');
            const initialContent = '<p class="text-gray-500 text-center py-4" id="no-exercises-message">è¯·é€‰æ‹©ä¸€ä¸ªè‚Œè‚‰ç¾¤ã€‚</p><div id="exercise-list-loader" class="hidden justify-center items-center py-8"><div class="loader"></div></div>';
            exerciseListContainer.innerHTML = initialContent; // é‡ç½®å†…å®¹
            // å†æ¬¡è·å–loaderçš„å¼•ç”¨ï¼Œç¡®ä¿å®ƒæ˜¯æœ€æ–°çš„DOMå…ƒç´ 
            let exerciseListLoader = document.getElementById('exercise-list-loader');
            if(exerciseListLoader) exerciseListLoader.style.display = 'none'; // ç¡®ä¿åˆå§‹æ˜¯éšè—çš„
        }

        // --- LocalStorage æ•°æ®ç®¡ç† ---
        function saveSessionToLocalStorage() {
            const exerciseBlocks = document.querySelectorAll('#current-session-container .exercise-block');
            const exercisesData = []; // ç”¨äºå­˜å‚¨è¦ä¿å­˜çš„è®­ç»ƒæ•°æ®

            exerciseBlocks.forEach(block => {
                const exerciseSelect = block.querySelector('.exercise-select');
                const exerciseName = exerciseSelect ? exerciseSelect.value : ''; 
                
                // åªæœ‰å½“åŠ¨ä½œåç§°æœ‰æ•ˆä¸”ä¸ä¸º"æ·»åŠ æ–°åŠ¨ä½œ"æ—¶æ‰ä¿å­˜
                if (exerciseName && exerciseName !== 'add_new') {
                    const setsData = [];
                    const setElements = block.querySelectorAll('.set-item');
                    setElements.forEach(setEl => {
                        const weightInput = setEl.querySelector('.set-weight');
                        const repsInput = setEl.querySelector('.set-reps');
                        setsData.push({
                            weight: weightInput ? weightInput.value : '', // ä¿å­˜å½“å‰è¾“å…¥å€¼
                            reps: repsInput ? repsInput.value : ''
                        });
                    });
                    exercisesData.push({ exercise_name: exerciseName, sets_data: setsData });
                }
            });

            // å¦‚æœæœ‰å®é™…æ•°æ®ï¼ˆä¸ä»…ä»…æ˜¯ç©ºçš„é»˜è®¤å—ï¼‰ï¼Œåˆ™ä¿å­˜åˆ°LocalStorage
            if (exercisesData.length > 0) {
                try {
                    localStorage.setItem(`currentSessionData_${currentMuscleGroup}`, JSON.stringify(exercisesData));
                    // console.log(`Session for ${currentMuscleGroup} saved to LocalStorage.`);
                } catch (e) {
                    console.error("ä¿å­˜åˆ°LocalStorageæ—¶å‡ºé”™:", e);
                }
            } else {
                // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„è®­ç»ƒæ•°æ®ï¼Œåˆ™æ¸…é™¤æ—§çš„LocalStorageæ•°æ®
                localStorage.removeItem(`currentSessionData_${currentMuscleGroup}`);
            }
        }

        async function loadSessionFromLocalStorage() {
            const savedData = localStorage.getItem(`currentSessionData_${currentMuscleGroup}`);
            if (savedData) {
                try {
                    const exercises = JSON.parse(savedData);
                    if (exercises.length > 0) {
                        document.getElementById('current-session-container').innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹
                        
                        // ç¡®ä¿availableExerciseså·²åŠ è½½ï¼Œä»¥ä¾¿æ­£ç¡®è®¾ç½®ä¸‹æ‹‰èœå•çš„å€¼
                        if (availableExercises.length === 0) {
                            await loadAvailableExercises(); 
                        }

                        exercises.forEach(exercise => {
                            // ä¸ºæ¯ä¸ªåŠ¨ä½œå—ç”Ÿæˆå”¯ä¸€ID
                            const exerciseId = `ex-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`; 
                            const exerciseDiv = document.createElement('div');
                            exerciseDiv.id = exerciseId;
                            exerciseDiv.className = 'exercise-block bg-gray-800 p-3 rounded-lg border border-gray-600';
                            exerciseDiv.innerHTML = `
                                <div class="flex items-center gap-2">
                                    <select class="exercise-select w-full bg-gray-900 rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" onchange="handleExerciseSelectChange(this); saveSessionToLocalStorage();"></select>
                                    <button onclick="this.parentElement.parentElement.remove(); saveSessionToLocalStorage();" class="text-red-500 hover:text-red-400 p-1 text-2xl font-bold">Ã—</button>
                                </div>
                                <div class="sets-container mt-3 space-y-2"></div>
                                <button onclick="addSetToExercise('${exerciseId}'); saveSessionToLocalStorage();" class="mt-2 w-full text-sm bg-gray-600 hover:bg-gray-500 rounded p-2">+ æ·»åŠ ä¸€ç»„</button>
                            `;
                            document.getElementById('current-session-container').appendChild(exerciseDiv);

                            // å¡«å……åŠ¨ä½œé€‰æ‹©å™¨
                            const selectElement = exerciseDiv.querySelector('.exercise-select');
                            let optionsHtml = availableExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');
                            optionsHtml += '<option value="add_new" class="text-blue-400 font-bold">-- æ·»åŠ æ–°åŠ¨ä½œ --</option>';
                            selectElement.innerHTML = optionsHtml;
                            selectElement.value = exercise.exercise_name; // è®¾ç½®ä¸ºä¸Šæ¬¡ä¿å­˜çš„åŠ¨ä½œå

                            // å¡«å……ç»„æ•°æ•°æ®
                            const setsContainer = exerciseDiv.querySelector('.sets-container');
                            exercise.sets_data.forEach((set, i) => {
                                const setDiv = document.createElement('div');
                                setDiv.className = 'set-item flex items-center gap-2';
                                setDiv.innerHTML = `
                                    <span class="text-gray-400 w-12 text-sm">ç¬¬${i + 1}ç»„</span>
                                    <input type="number" placeholder="é‡é‡(kg)" value="${set.weight}" class="set-weight w-full bg-gray-900 rounded p-2 text-center focus:outline-none focus:ring-1 focus:ring-blue-400" oninput="saveSessionToLocalStorage()">
                                    <span class="text-gray-500">x</span>
                                    <input type="number" placeholder="æ¬¡æ•°" value="${set.reps}" class="set-reps w-full bg-gray-900 rounded p-2 text-center focus:outline-none focus:ring-1 focus:ring-blue-400" oninput="saveSessionToLocalStorage()">
                                    <button onclick="this.parentElement.remove(); updateSetNumbers('${exerciseId}'); saveSessionToLocalStorage();" class="text-red-600 p-1 text-lg">Ã—</button>
                                `;
                                setsContainer.appendChild(setDiv);
                            });
                        });
                        return true; // æ•°æ®åŠ è½½æˆåŠŸ
                    }
                } catch (e) {
                    console.error("è§£æLocalStorageæ•°æ®æ—¶å‡ºé”™:", e);
                    localStorage.removeItem(`currentSessionData_${currentMuscleGroup}`); // æ¸…é™¤æŸåçš„æ•°æ®
                }
            }
            return false; // æ²¡æœ‰æ‰¾åˆ°æ•°æ®æˆ–åŠ è½½å¤±è´¥
        }

        // --- åŠ¨ä½œç®¡ç† (è®­ç»ƒé¡µé¢å’ŒåŠ¨ä½œç®¡ç†é¡µé¢å…±ç”¨) ---
        async function loadAvailableExercises() {
            try {
                const response = await fetch(`${API_BASE_URL}/exercises/${currentMuscleGroup}`);
                if (!response.ok) throw new Error('åŠ è½½åŠ¨ä½œåˆ—è¡¨å¤±è´¥');
                availableExercises = await response.json();
            } catch (error) {
                console.error(error);
                showModal('é”™è¯¯', 'åŠ è½½é¢„è®¾åŠ¨ä½œåˆ—è¡¨å¤±è´¥ã€‚');
            }
        }

        function updateAllExerciseDropdowns() {
            const selects = document.querySelectorAll('.exercise-select');
            selects.forEach(select => {
                const currentValue = select.value; // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
                let optionsHtml = availableExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');
                optionsHtml += '<option value="add_new" class="text-blue-400 font-bold">-- æ·»åŠ æ–°åŠ¨ä½œ --</option>';
                select.innerHTML = optionsHtml;
                if (currentValue && availableExercises.includes(currentValue)) {
                    select.value = currentValue; // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
                } else if (availableExercises.length > 0) {
                    select.value = availableExercises[0]; // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                } else {
                    select.value = ''; // å¦‚æœæ²¡æœ‰å¯ç”¨åŠ¨ä½œï¼Œåˆ™è®¾ç½®ä¸ºç©º
                }
            });
        }

        async function handleExerciseSelectChange(selectElement) {
            if (selectElement.value === 'add_new') {
                // ä½¿ç”¨ prompt è·å–æ–°åŠ¨ä½œåç§°ï¼Œå› ä¸ºè¿™ä¸ªåœºæ™¯ä¸‹éœ€è¦ç”¨æˆ·è¾“å…¥
                const newExerciseName = prompt(`ä¸ºã€${document.getElementById('training-title').textContent}ã€‘æ·»åŠ æ–°åŠ¨ä½œåç§°ï¼š`);
                if (newExerciseName && newExerciseName.trim() !== '') {
                    try {
                        selectElement.disabled = true; // ç¦ç”¨é€‰æ‹©å™¨ï¼Œé˜²æ­¢é‡å¤æäº¤
                        const response = await fetch(`${API_BASE_URL}/exercises`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ muscle_group: currentMuscleGroup, exercise_name: newExerciseName.trim() })
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'æ·»åŠ æ–°åŠ¨ä½œå¤±è´¥ã€‚');
                        }
                        await loadAvailableExercises(); // é‡æ–°åŠ è½½æœ€æ–°åŠ¨ä½œåˆ—è¡¨
                        updateAllExerciseDropdowns(); // æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰èœå•
                        selectElement.value = newExerciseName.trim(); // é€‰ä¸­æ–°æ·»åŠ çš„åŠ¨ä½œ
                        saveSessionToLocalStorage(); // ä¿å­˜åˆ°LocalStorage
                        showModal('æˆåŠŸ', `åŠ¨ä½œ "${newExerciseName.trim()}" å·²æ·»åŠ ï¼`);
                    } catch (error) {
                        showModal('é”™è¯¯', error.message);
                        selectElement.value = availableExercises[0] || ''; // å¤±è´¥åˆ™æ¢å¤é»˜è®¤å€¼
                    } finally {
                        selectElement.disabled = false; // é‡æ–°å¯ç”¨é€‰æ‹©å™¨
                    }
                } else {
                    selectElement.value = availableExercises[0] || ''; // ç”¨æˆ·å–æ¶ˆæˆ–è¾“å…¥ä¸ºç©ºï¼Œæ¢å¤é»˜è®¤å€¼
                }
            }
            saveSessionToLocalStorage(); // åŠ¨ä½œé€‰æ‹©æ”¹å˜æ—¶ä¿å­˜åˆ°LocalStorage
        }
        
        // --- å½“å‰è®­ç»ƒä¼šè¯ç®¡ç† ---
        function addExerciseToSession() {
            const exerciseId = `ex-${Date.now()}`; // ä¸ºæ–°åŠ¨ä½œç”Ÿæˆå”¯ä¸€ID
            const exerciseDiv = document.createElement('div');
            exerciseDiv.id = exerciseId;
            exerciseDiv.className = 'exercise-block bg-gray-800 p-3 rounded-lg border border-gray-600';
            exerciseDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <select class="exercise-select w-full bg-gray-900 rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" onchange="handleExerciseSelectChange(this); saveSessionToLocalStorage();"></select>
                    <button onclick="this.parentElement.parentElement.remove(); saveSessionToLocalStorage();" class="text-red-500 hover:text-red-400 p-1 text-2xl font-bold">Ã—</button>
                </div>
                <div class="sets-container mt-3 space-y-2"></div>
                <button onclick="addSetToExercise('${exerciseId}'); saveSessionToLocalStorage();" class="mt-2 w-full text-sm bg-gray-600 hover:bg-gray-500 rounded p-2">+ æ·»åŠ ä¸€ç»„</button>
            `;
            document.getElementById('current-session-container').appendChild(exerciseDiv);
            addSetToExercise(exerciseId); // è‡ªåŠ¨ä¸ºæ–°åŠ¨ä½œæ·»åŠ ç¬¬ä¸€ç»„
            updateAllExerciseDropdowns(); // æ›´æ–°æ–°æ·»åŠ çš„ä¸‹æ‹‰èœå•
            saveSessionToLocalStorage(); // æ·»åŠ æ–°åŠ¨ä½œå—åä¿å­˜
        }

        function addSetToExercise(exerciseId) {
            const setsContainer = document.querySelector(`#${exerciseId} .sets-container`);
            const setCount = setsContainer.children.length + 1; // è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ ç»„
            
            // è·å–ä¸Šä¸€ç»„çš„é‡é‡ä½œä¸ºé»˜è®¤å€¼
            let defaultWeight = '';
            // å¦‚æœä¸æ˜¯ç¬¬ä¸€ç»„ï¼Œå°è¯•è·å–ä¸Šä¸€ç»„çš„é‡é‡
            if (setCount > 1) {
                const previousSetWeightInput = setsContainer.querySelector(`.set-item:last-child .set-weight`);
                if (previousSetWeightInput) {
                    defaultWeight = previousSetWeightInput.value;
                }
            }

            const setDiv = document.createElement('div');
            setDiv.className = 'set-item flex items-center gap-2';
            setDiv.innerHTML = `
                <span class="text-gray-400 w-12 text-sm">ç¬¬${setCount}ç»„</span>
                <input type="number" placeholder="é‡é‡(kg)" value="${defaultWeight}" class="set-weight w-full bg-gray-900 rounded p-2 text-center focus:outline-none focus:ring-1 focus:ring-blue-400" oninput="saveSessionToLocalStorage()">
                <span class="text-gray-500">x</span>
                <input type="number" placeholder="æ¬¡æ•°" class="set-reps w-full bg-gray-900 rounded p-2 text-center focus:outline-none focus:ring-1 focus:ring-blue-400" oninput="saveSessionToLocalStorage()">
                <button onclick="this.parentElement.remove(); updateSetNumbers('${exerciseId}'); saveSessionToLocalStorage();" class="text-red-600 p-1 text-lg">Ã—</button>
            `;
            setsContainer.appendChild(setDiv);
            saveSessionToLocalStorage(); // æ·»åŠ æ–°ç»„åä¿å­˜
        }
        
        function updateSetNumbers(exerciseId) {
            const setsContainer = document.querySelector(`#${exerciseId} .sets-container`);
            const allSetSpans = setsContainer.querySelectorAll('.set-item span:first-child');
            allSetSpans.forEach((span, i) => {
                span.textContent = `ç¬¬${i + 1}ç»„`; // æ›´æ–°ç»„æ•°æ˜¾ç¤º
            });
        }

        async function saveSession() {
            const saveButton = document.getElementById('save-session-button');
            saveButton.disabled = true; // Disable the button immediately
            saveButton.textContent = 'ä¿å­˜ä¸­...'; // Change button text to indicate loading state
            saveButton.classList.remove('bg-green-600', 'hover:bg-green-500');
            saveButton.classList.add('bg-gray-500'); // Optional: change color to gray

            const exerciseBlocks = document.querySelectorAll('.exercise-block');
            if (exerciseBlocks.length === 0) {
                showModal('æç¤º', 'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè®­ç»ƒåŠ¨ä½œã€‚');
                saveButton.disabled = false; // Re-enable button
                saveButton.textContent = 'âœ“ å®Œæˆå¹¶ä¿å­˜æœ¬æ¬¡è®­ç»ƒ'; // Restore button text
                saveButton.classList.remove('bg-gray-500');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                return;
            }

            const exercisesData = [];
            for (const block of exerciseBlocks) {
                const exerciseName = block.querySelector('.exercise-select').value;
                if (!exerciseName || exerciseName === 'add_new') {
                    showModal('é”™è¯¯', 'è¯·ä¸ºæ‰€æœ‰åŠ¨ä½œé€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„åç§°ã€‚');
                    saveButton.disabled = false; // Re-enable button
                    saveButton.textContent = 'âœ“ å®Œæˆå¹¶ä¿å­˜æœ¬æ¬¡è®­ç»ƒ'; // Restore button text
                    saveButton.classList.remove('bg-gray-500');
                    saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                    return;
                }

                const setsData = [];
                const setElements = block.querySelectorAll('.set-item');
                let lastValidWeight = ''; // ç”¨äºå­˜å‚¨ä¸Šä¸€ç»„çš„æœ‰æ•ˆé‡é‡

                for (let i = 0; i < setElements.length; i++) {
                    const weightInput = setElements[i].querySelector('.set-weight');
                    const repsInput = setElements[i].querySelector('.set-reps');
                    let weight = weightInput.value.trim();
                    const reps = repsInput.value.trim();

                    if (i === 0 && !weight) { 
                        showModal('é”™è¯¯', `åŠ¨ä½œ "${exerciseName}" çš„ç¬¬ä¸€ç»„é‡é‡æ˜¯å¿…å¡«é¡¹ï¼`); 
                        saveButton.disabled = false; // Re-enable button
                        saveButton.textContent = 'âœ“ å®Œæˆå¹¶ä¿å­˜æœ¬æ¬¡è®­ç»ƒ'; // Restore button text
                        saveButton.classList.remove('bg-gray-500');
                        saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                        return; 
                    }
                    if (!reps) { 
                        showModal('é”™è¯¯', `åŠ¨ä½œ "${exerciseName}" çš„ç¬¬ ${i+1} ç»„æ¬¡æ•°ä¸èƒ½ä¸ºç©ºï¼`); 
                        saveButton.disabled = false; // Re-enable button
                        saveButton.textContent = 'âœ“ å®Œæˆå¹¶ä¿å­˜æœ¬æ¬¡è®­ç»ƒ'; // Restore button text
                        saveButton.classList.remove('bg-gray-500');
                        saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                        return; 
                    }
                    
                    // å¦‚æœå½“å‰ç»„æ²¡æœ‰è¾“å…¥é‡é‡ï¼Œåˆ™ä½¿ç”¨ä¸Šä¸€ç»„çš„æœ‰æ•ˆé‡é‡
                    if (!weight) {
                        weight = lastValidWeight; 
                    } else {
                        lastValidWeight = weight; // æ›´æ–°ä¸Šä¸€ç»„çš„æœ‰æ•ˆé‡é‡
                    }

                    setsData.push({ weight: parseFloat(weight), reps: parseInt(reps) });
                }
                
                if (setsData.length > 0) {
                    exercisesData.push({ exercise_name: exerciseName, sets_data: setsData });
                }
            }

            if (exercisesData.length === 0) {
                showModal('æç¤º', 'æ²¡æœ‰æœ‰æ•ˆçš„è®­ç»ƒæ•°æ®å¯ä»¥ä¿å­˜ã€‚');
                saveButton.disabled = false; // Re-enable button
                saveButton.textContent = 'âœ“ å®Œæˆå¹¶ä¿å­˜æœ¬æ¬¡è®­ç»ƒ'; // Restore button text
                saveButton.classList.remove('bg-gray-500');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                return;
            }

            // Set up a timeout for the fetch request
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 5000); // 5-second timeout

            try {
                const response = await fetch(`${API_BASE_URL}/session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ muscle_group: currentMuscleGroup, exercises_data: exercisesData }),
                    signal: controller.signal // Associate the abort controller with the fetch request
                });
                clearTimeout(id); // Clear the timeout if the request completes in time

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ä¿å­˜å¤±è´¥');
                }
                
                showModal('æˆåŠŸ', 'è®­ç»ƒå·²ä¿å­˜ï¼');
                document.getElementById('current-session-container').innerHTML = ''; // æ¸…ç©ºå½“å‰è®­ç»ƒç•Œé¢
                addExerciseToSession(); // æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„ç©ºåŠ¨ä½œå—
                localStorage.removeItem(`currentSessionData_${currentMuscleGroup}`); // **é‡è¦ï¼šæˆåŠŸä¿å­˜åæ¸…é™¤LocalStorageæ•°æ®**
                await loadHistory(); // é‡æ–°åŠ è½½å†å²è®°å½•
            } catch (error) {
                if (error.name === 'AbortError') {
                    showModal('ä¿å­˜å¤±è´¥', 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚');
                } else {
                    showModal('ä¿å­˜å¤±è´¥', error.message);
                }
            } finally {
                saveButton.disabled = false; // Re-enable button
                saveButton.textContent = 'âœ“ å®Œæˆå¹¶ä¿å­˜æœ¬æ¬¡è®­ç»ƒ'; // Restore button text
                saveButton.classList.remove('bg-gray-500');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
            }
        }

        // --- å†å²è®°å½•ç®¡ç† ---
        async function loadHistory() {
            const historyContainer = document.getElementById('history-container');
            let loader = document.getElementById('loader'); // ä½¿ç”¨ let å£°æ˜

            // é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¦‚æœ loader å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ™é‡æ–°åˆ›å»ºå¹¶æ·»åŠ åˆ° DOM ä¸­
            if (!loader) {
                console.warn("Loader element not found, recreating it for history container."); // æ·»åŠ è­¦å‘Šæ—¥å¿—
                loader = document.createElement('div');
                loader.id = 'loader';
                loader.className = 'hidden justify-center items-center py-8';
                loader.innerHTML = '<div class="loader"></div>';
                historyContainer.appendChild(loader); // å°† loader æ·»åŠ å› historyContainer
            }

            // 1. æ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„è®­ç»ƒä¼šè¯æ¡ç›®ï¼ˆå†å²è®°å½•å—ï¼‰
            historyContainer.querySelectorAll('.bg-gray-700\\/50').forEach(el => el.remove());

            // 2. æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„"æš‚æ— å†å²è®°å½•"æ¶ˆæ¯
            const noHistoryMessage = document.getElementById('no-history-message');
            if (noHistoryMessage) {
                noHistoryMessage.remove();
            }

            // 3. æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„"åŠ è½½å¤±è´¥"æ¶ˆæ¯
            const loadErrorMessage = document.getElementById('load-error-message');
            if (loadErrorMessage) {
                loadErrorMessage.remove();
            }

            // åœ¨å°è¯•è®¿é—® style å±æ€§ä¹‹å‰ï¼Œå†æ¬¡ç¡®è®¤ loader ä¸ä¸º null
            if (loader) {
                console.log("Loader element for history before setting style:", loader); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                loader.style.display = 'flex'; // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            } else {
                console.error("Critical error: History loader element is null even after recreation attempt.");
                // æ­¤æ—¶å¯ä»¥è€ƒè™‘ç›´æ¥è¿”å›æˆ–æ˜¾ç¤ºä¸€ä¸ªæ— æ³•åŠ è½½çš„é”™è¯¯ä¿¡æ¯
                historyContainer.insertAdjacentHTML('beforeend', `<p class="text-red-400 text-center py-4">å†å²è®°å½•åŠ è½½å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚</p>`);
                return; // é˜»æ­¢åç»­æ“ä½œ
            }

            try {
                const response = await fetch(`${API_BASE_URL}/history/${currentMuscleGroup}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'åŠ è½½å¤±è´¥');
                }
                const sessions = await response.json();

                if (loader) loader.style.display = 'none'; // éšè—åŠ è½½åŠ¨ç”»
                else console.warn("History loader element became null while fetching data.");


                if (sessions.length === 0) {
                    // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œåˆ™æ·»åŠ "æš‚æ— å†å²è®°å½•"æ¶ˆæ¯ï¼Œå¹¶ç»™å®ƒä¸€ä¸ªID
                    historyContainer.insertAdjacentHTML('beforeend', '<p id="no-history-message" class="text-gray-500 text-center py-4">æš‚æ— å†å²è®°å½•ã€‚</p>');
                    return;
                }

                let html = '';
                sessions.forEach(session => {
                    html += `
                        <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600/50">
                            <div class="flex justify-between items-center border-b border-gray-600 pb-2 mb-3">
                                <h3 class="font-bold text-lg text-blue-300">${session.session_date}</h3>
                                <button onclick="deleteSession(${session.session_id})" class="text-gray-500 hover:text-red-400 text-xl">ğŸ—‘ï¸</button>
                            </div>
                            <div class="space-y-3">
                    `;
                    session.exercises_data.forEach(workout => {
                        html += `
                                    <div>
                                        <p class="font-semibold text-white">${workout.exercise_name}</p>
                                        <div class="text-sm text-gray-300 pl-4 border-l-2 border-gray-600 mt-1 ml-1">
                                            ${workout.sets_data.map((s, i) => `<span>ç¬¬${i+1}ç»„: ${s.weight}kg &times; ${s.reps}æ¬¡</span>`).join('<br>')}
                                        </div>
                                    </div>
                        `;
                    });
                    html += `</div></div>`;
                });
                historyContainer.insertAdjacentHTML('beforeend', html); // å°†æ–°å†å²è®°å½•æ·»åŠ åˆ°å®¹å™¨
            } catch (error) {
                if (loader) loader.style.display = 'none'; // éšè—åŠ è½½åŠ¨ç”»
                else console.warn("History loader element was null during error handling.");
                // åœ¨åŠ è½½å¤±è´¥æ—¶ï¼Œä¹Ÿç»™è¿™ä¸ªæ¶ˆæ¯ä¸€ä¸ªID
                historyContainer.insertAdjacentHTML('beforeend', `<p id="load-error-message" class="text-red-400 text-center py-4">åŠ è½½å¤±è´¥: ${error.message}</p>`);
            }
        }
        
        async function deleteSession(sessionId) {
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤æ¨¡æ€æ¡†æ›¿ä»£åŸç”Ÿçš„ confirm()
            showConfirmModal('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™æ¬¡è®­ç»ƒè®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚', async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/session/${sessionId}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'åˆ é™¤å¤±è´¥');
                    }
                    showModal('æˆåŠŸ', 'è®­ç»ƒè®°å½•å·²åˆ é™¤ã€‚');
                    await loadHistory(); // é‡æ–°åŠ è½½å†å²è®°å½•ä»¥æ›´æ–°ç•Œé¢
                } catch (error) {
                    showModal('åˆ é™¤å¤±è´¥', error.message);
                }
            });
        }

        // --- åŠ¨ä½œç®¡ç†é¡µé¢åŠŸèƒ½ ---
        async function loadExercisesForManagement(muscle) {
            currentManageMuscleGroup = muscle;
            const exerciseListContainer = document.getElementById('exercise-list-container');
            let exerciseListLoader = document.getElementById('exercise-list-loader'); // ä½¿ç”¨ let å£°æ˜

            // é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¦‚æœ loader å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ™é‡æ–°åˆ›å»ºå¹¶æ·»åŠ åˆ° DOM ä¸­
            if (!exerciseListLoader) {
                console.warn("Exercise list loader element not found, recreating it for management container."); // æ·»åŠ è­¦å‘Šæ—¥å¿—
                exerciseListLoader = document.createElement('div');
                exerciseListLoader.id = 'exercise-list-loader';
                exerciseListLoader.className = 'hidden justify-center items-center py-8';
                exerciseListLoader.innerHTML = '<div class="loader"></div>';
                exerciseListContainer.appendChild(exerciseListLoader); // å°† loader æ·»åŠ å› exerciseListContainer
            }

            // 1. æ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„åŠ¨ä½œåˆ—è¡¨é¡¹ï¼ˆclass="flex items-center justify-between"ï¼‰
            exerciseListContainer.querySelectorAll('.flex.items-center.justify-between').forEach(el => el.remove());

            // 2. æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„"è¯·é€‰æ‹©ä¸€ä¸ªè‚Œè‚‰ç¾¤"æˆ–"è¯¥è‚Œè‚‰ç¾¤æš‚æ— åŠ¨ä½œ"æ¶ˆæ¯
            const noExercisesMessage = document.getElementById('no-exercises-message');
            if (noExercisesMessage) {
                noExercisesMessage.remove();
            }
            // 3. æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„åŠ è½½å¤±è´¥æ¶ˆæ¯ (å¦‚æœç®¡ç†é¡µé¢ä¹Ÿæœ‰)
            const managementLoadErrorMessage = document.getElementById('management-load-error-message');
            if (managementLoadErrorMessage) {
                managementLoadErrorMessage.remove();
            }

            if (!muscle) {
                exerciseListContainer.insertAdjacentHTML('beforeend', '<p class="text-gray-500 text-center py-4" id="no-exercises-message">è¯·é€‰æ‹©ä¸€ä¸ªè‚Œè‚‰ç¾¤ã€‚</p>');
                if (exerciseListLoader) exerciseListLoader.style.display = 'none'; // Hide loader if no muscle selected
                return;
            }

            // åœ¨å°è¯•è®¿é—® style å±æ€§ä¹‹å‰ï¼Œå†æ¬¡ç¡®è®¤ loader ä¸ä¸º null
            if (exerciseListLoader) {
                console.log("Loader element for management before setting style:", exerciseListLoader); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                exerciseListLoader.style.display = 'flex'; // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            } else {
                console.error("Critical error: Management loader element is null even after recreation attempt.");
                exerciseListContainer.insertAdjacentHTML('beforeend', `<p class="text-red-400 text-center py-4">åŠ¨ä½œç®¡ç†åŠ è½½å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚</p>`);
                return; // é˜»æ­¢åç»­æ“ä½œ
            }

            try {
                const response = await fetch(`${API_BASE_URL}/exercises/${muscle}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'åŠ è½½åŠ¨ä½œåˆ—è¡¨å¤±è´¥');
                }
                const exercises = await response.json();

                if (exerciseListLoader) exerciseListLoader.style.display = 'none'; // éšè—åŠ è½½åŠ¨ç”»
                else console.warn("Management loader element became null while fetching data.");


                if (exercises.length === 0) {
                    exerciseListContainer.insertAdjacentHTML('beforeend', '<p class="text-gray-500 text-center py-4" id="no-exercises-message">è¯¥è‚Œè‚‰ç¾¤æš‚æ— åŠ¨ä½œï¼Œè¯·æ·»åŠ ã€‚</p>');
                    return;
                }

                let html = '';
                exercises.forEach(ex => {
                    html += `
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg border border-gray-600">
                            <span class="text-white text-lg flex-grow mr-2">${ex}</span>
                            <div class="flex gap-2">
                                <button onclick="editExercise('${muscle}', '${ex}')" class="bg-blue-600 hover:bg-blue-500 text-white py-1 px-3 rounded text-sm">ç¼–è¾‘</button>
                                <button onclick="deleteExerciseFromManagement('${muscle}', '${ex}')" class="bg-red-600 hover:bg-red-500 text-white py-1 px-3 rounded text-sm">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
                exerciseListContainer.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                if (exerciseListLoader) exerciseListLoader.style.display = 'none';
                else console.warn("Management loader element was null during error handling.");
                exerciseListContainer.insertAdjacentHTML('beforeend', `<p id="management-load-error-message" class="text-red-400 text-center py-4">åŠ è½½åŠ¨ä½œå¤±è´¥: ${error.message}</p>`);
            }
        }

        async function addNewExercise() {
            const muscle = document.getElementById('manage-muscle-select').value;
            const newExerciseInput = document.getElementById('new-exercise-input');
            const newExerciseName = newExerciseInput.value.trim();

            if (!muscle) {
                showModal('æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè‚Œè‚‰ç¾¤ã€‚');
                return;
            }
            if (!newExerciseName) {
                showModal('æç¤º', 'è¯·è¾“å…¥æ–°åŠ¨ä½œåç§°ã€‚');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/exercises`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ muscle_group: muscle, exercise_name: newExerciseName })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'æ·»åŠ å¤±è´¥');
                }
                showModal('æˆåŠŸ', `åŠ¨ä½œ "${newExerciseName}" å·²æ·»åŠ ã€‚`);
                newExerciseInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                await loadExercisesForManagement(muscle); // é‡æ–°åŠ è½½åˆ—è¡¨
                // åˆ·æ–°è®­ç»ƒé¡µé¢çš„å¯ç”¨åŠ¨ä½œåˆ—è¡¨
                currentMuscleGroup = muscle; // ä¸´æ—¶è®¾ç½®ï¼Œç¡®ä¿loadAvailableExercisesåŠ è½½æ­£ç¡®
                await loadAvailableExercises(); 
                updateAllExerciseDropdowns();
            } catch (error) {
                showModal('æ·»åŠ å¤±è´¥', error.message);
            }
        }

        async function editExercise(muscle, oldName) {
            // ä½¿ç”¨ prompt è·å–æ–°åŠ¨ä½œåç§°
            const newName = prompt(`ç¼–è¾‘åŠ¨ä½œ "${oldName}" çš„åç§°ï¼š`, oldName);
            if (newName === null || newName.trim() === '' || newName.trim() === oldName) {
                // ç”¨æˆ·å–æ¶ˆæˆ–è¾“å…¥ä¸ºç©ºæˆ–åç§°æœªæ”¹å˜
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/exercises`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ muscle_group: muscle, old_exercise_name: oldName, new_exercise_name: newName.trim() })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ç¼–è¾‘å¤±è´¥');
                }
                showModal('æˆåŠŸ', `åŠ¨ä½œ "${oldName}" å·²æ›´æ–°ä¸º "${newName.trim()}"ã€‚`);
                await loadExercisesForManagement(muscle); // é‡æ–°åŠ è½½åˆ—è¡¨
                // åˆ·æ–°è®­ç»ƒé¡µé¢çš„å¯ç”¨åŠ¨ä½œåˆ—è¡¨
                currentMuscleGroup = muscle; // ä¸´æ—¶è®¾ç½®ï¼Œç¡®ä¿loadAvailableExercisesåŠ è½½æ­£ç¡®
                await loadAvailableExercises(); 
                updateAllExerciseDropdowns();
            } catch (error) {
                showModal('ç¼–è¾‘å¤±è´¥', error.message);
            }
        }

        async function deleteExerciseFromManagement(muscle, exerciseName) {
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤æ¨¡æ€æ¡†æ›¿ä»£åŸç”Ÿçš„ confirm()
            showConfirmModal('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤åŠ¨ä½œ "${exerciseName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`, async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/exercises`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ muscle_group: muscle, exercise_name: exerciseName })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'åˆ é™¤å¤±è´¥');
                    }
                    showModal('æˆåŠŸ', `åŠ¨ä½œ "${exerciseName}" å·²åˆ é™¤ã€‚`);
                    await loadExercisesForManagement(muscle); // é‡æ–°åŠ è½½åˆ—è¡¨
                    // åˆ·æ–°è®­ç»ƒé¡µé¢çš„å¯ç”¨åŠ¨ä½œåˆ—è¡¨
                    currentMuscleGroup = muscle; // ä¸´æ—¶è®¾ç½®ï¼Œç¡®ä¿loadAvailableExercisesåŠ è½½æ­£ç¡®
                    await loadAvailableExercises(); 
                    updateAllExerciseDropdowns();
                } catch (error) {
                    showModal('åˆ é™¤å¤±è´¥', error.message);
                }
            });
        }

        // --- é¡µé¢åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => showHomePage());
    </script>
</body>
</html>