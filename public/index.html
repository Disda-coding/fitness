<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>健身追踪器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3a86ff;
            --secondary: #ff006e;
            --accent: #8338ec;
            --dark: #111827;
            --darker: #0a0f1d;
            --card-bg: #1e293b;
        }
        
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background: radial-gradient(circle at top, var(--darker), var(--dark));
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .page { 
            display: none; 
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page.active { display: block; }
        
        /* 头部样式 */
        .app-header {
            text-align: center;
            padding: 1.5rem 1rem;
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .app-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 8px rgba(58, 134, 255, 0.2);
        }
        
        .app-subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* 卡片样式 */
        .card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(26, 32, 44, 0.8));
            border: 1px solid rgba(74, 85, 104, 0.3);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(74, 85, 104, 0.3);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center; /* 添加居中 */
        }
        
        .card-title i {
            margin-right: 0.75rem;
            font-size: 1.3rem;
        }
        
        /* 网格布局 */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* 手机端最小宽度改为140px */
            gap: 1rem; /* 缩小间隙以适应小屏幕 */
            margin-bottom: 2rem;
        }

        /* 手机端特定样式 */
        @media (max-width: 640px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr); /* 固定两列布局 */
            }
            
            /* 让动作管理卡片单独占据一行 */
            .muscle-card:nth-last-child(1) {
                grid-column: 1 / -1;
            }
            
            /* 调整卡片高度以适应更小的屏幕 */
            .muscle-card {
                height: 160px;
            }
            
            /* 调整图标和文字大小 */
            .muscle-icon {
                font-size: 2.5rem;
            }
            
            .muscle-name {
                font-size: 1.2rem;
            }

            /* 动作管理页面的按钮样式 */
            #exercise-management-page .flex.gap-3 {
                flex-direction: column;
            }
            
            #exercise-management-page .flex.gap-3 > * {
                width: 100%;
            }
            
            #exercise-management-page .flex.gap-3 > button {
                margin-top: 0.5rem;
            }
        }

        /* 平板和桌面端保持原有样式 */
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            
            .muscle-card {
                height: 200px;
            }
            
            .muscle-icon {
                font-size: 3.5rem;
            }
            
            .muscle-name {
                font-size: 1.4rem;
            }
        }
        
        /* 肌肉群卡片 */
        .muscle-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            height: 200px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(26, 32, 44, 0.8));
            border: 1px solid rgba(74, 85, 104, 0.3);
        }
        
        .muscle-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--primary), var(--accent), var(--secondary));
            z-index: -1;
            border-radius: 18px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .muscle-card:hover::before {
            opacity: 1;
        }
        
        .muscle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .muscle-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }
        
        .muscle-card:hover .muscle-icon {
            transform: scale(1.1);
        }
        
        .muscle-name {
            font-size: 1.4rem;
            font-weight: 600;
            text-align: center;
        }
        
        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary), #5a9cff);
            color: white;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #2b78ff, #4a8cff);
            box-shadow: 0 6px 20px rgba(58, 134, 255, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, var(--accent), #9a5eff);
            color: white;
            box-shadow: 0 4px 15px rgba(131, 56, 236, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(90deg, #7327e6, #8847eb);
            box-shadow: 0 6px 20px rgba(131, 56, 236, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-action {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(74, 85, 104, 0.4);
            color: #cbd5e1;
        }
        
        .btn-action:hover {
            background: rgba(30, 41, 59, 1);
            border: 1px solid var(--primary);
            color: white;
        }
        
        /* 表单元素 */
        input, select {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(74, 85, 104, 0.4);
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%; /* 确保宽度一致 */
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
        }
        
        /* 加载动画 */
        .loader {
            border: 4px solid rgba(74, 85, 104, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 模态框 */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* 霓虹效果 */
        .neon-text {
            text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(58, 134, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
        }

        /* 动作管理模块下拉菜单样式 */
        #manage-muscle-select {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(74, 85, 104, 0.4);
            border-radius: 12px;
            padding: 0.8rem 1.2rem;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        #manage-muscle-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
        }
        
        /* 动作管理模块标题居中 */
        #exercise-management-page .card-header h2,
        #exercise-management-page h3 {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 主页 -->
        <div id="home-page" class="page active">
            <div class="app-header">
                <h1 class="app-title">健身追踪器</h1>
                <p class="app-subtitle">记录你的每一次训练，见证身体的变化</p>
            </div>
            
            <div class="grid-container">
                <div class="muscle-card" onclick="showTrainingPage('chest', '胸部训练')">
                    <div class="muscle-icon">💪</div>
                    <div class="muscle-name">胸 & 三头</div>
                </div>
                
                <div class="muscle-card" onclick="showTrainingPage('back', '背部训练')">
                    <div class="muscle-icon">🚀</div>
                    <div class="muscle-name">背 & 二头</div>
                </div>
                
                <div class="muscle-card" onclick="showTrainingPage('shoulders', '肩部训练')">
                    <div class="muscle-icon">🏋️</div>
                    <div class="muscle-name">肩部训练</div>
                </div>
                
                <div class="muscle-card" onclick="showTrainingPage('legs', '腿部训练')">
                    <div class="muscle-icon">🦵</div>
                    <div class="muscle-name">腿 & 核心</div>
                </div>
                
                <div class="muscle-card" onclick="showExerciseManagementPage()">
                    <div class="muscle-icon">⚙️</div>
                    <div class="muscle-name">动作管理</div>
                </div>
            </div>
            
     
        </div>

        <!-- 训练页面 -->
        <div id="training-page" class="page">
            <div class="flex items-center mb-6">
                <button onclick="showHomePage()" class="btn btn-action mr-4">
                    <i class="fas fa-arrow-left mr-2"></i> 返回
                </button>
                <h1 id="training-title" class="text-2xl font-bold text-white flex-grow text-center"></h1>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-dumbbell"></i> 记录今日训练</h2>
                    </div>
                    
                    <div id="current-session-container" class="space-y-4 mb-4">
                        <!-- 动态内容 -->
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mt-6">
                        <button onclick="addExerciseToSession()" class="btn btn-primary flex-1">
                            <i class="fas fa-plus mr-2"></i> 添加新动作
                        </button>
                        <button id="save-session-button" onclick="saveSession()" class="btn btn-secondary flex-1">
                            <i class="fas fa-save mr-2"></i> 完成并保存
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-history"></i> 历史记录</h2>
                    </div>
                    
                    <div id="history-container" class="space-y-4">
                        <div id="loader" class="hidden justify-center items-center py-8">
                            <div class="loader"></div>
                        </div>
                        <!-- 历史记录内容 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 动作管理页面 -->
<!-- 动作管理页面部分代码 -->
<div id="exercise-management-page" class="page">
    <div class="flex items-center mb-6">
        <button onclick="showHomePage()" class="btn btn-action mr-4">
            <i class="fas fa-arrow-left mr-2"></i> 返回
        </button>
        <h1 class="text-2xl font-bold text-white flex-grow text-center">动作管理</h1>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-dumbbell"></i> 选择肌肉群</h2>
            </div>
            
            <select id="manage-muscle-select" onchange="loadExercisesForManagement(this.value)" 
                    class="w-full mb-4 bg-gray-800 border border-gray-600 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-blue-400 text-white">
                <option value="">-- 请选择肌肉群 --</option>
                <option value="chest">胸 & 三头</option>
                <option value="back">背 & 二头</option>
                <option value="shoulders">肩部</option>
                <option value="legs">腿 & 核心</option>
            </select>
            
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-300 text-center">添加新动作</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-exercise-input" placeholder="新动作名称" 
                           class="flex-1 bg-gray-800 border border-gray-600 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-blue-400 text-white">
                    <button onclick="addNewExercise()" class="btn btn-primary sm:w-auto w-full">
                        <i class="fas fa-plus mr-1"></i> 添加
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-list"></i> 动作列表</h2>
            </div>
            
            <div id="exercise-list-container" class="space-y-3">
                <p class="text-gray-500 text-center py-8" id="no-exercises-message">
                    <i class="fas fa-info-circle mr-2"></i>请选择一个肌肉群
                </p>
                <div id="exercise-list-loader" class="hidden justify-center items-center py-8">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
    </div>

    <!-- 模态框 -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-white"></h3>
            <p id="modal-body" class="text-gray-300 mb-6"></p>
            <div class="text-right" id="modal-actions">
                <button id="modal-close" class="btn btn-primary">好的</button>
            </div>
        </div>
    </div>

    <!-- JavaScript部分保持不变 -->
    <script>
        const API_BASE_URL = '/api'; // 后端API的基础URL
        let currentMuscleGroup = ''; // 当前选择的肌肉群 (用于训练页面)
        let currentManageMuscleGroup = ''; // 当前选择的肌肉群 (用于动作管理页面)
        let availableExercises = []; // 可用的动作列表

        // --- 模态框 (Modal) 逻辑 ---
        const modal = document.getElementById('modal');
        const modalActions = document.getElementById('modal-actions'); // 模态框按钮容器

        // 默认的"好的"按钮点击事件
        function defaultModalClose() {
            modal.style.display = 'none';
            restoreDefaultModalButton(); // 确保每次关闭后恢复默认按钮
        }
        // 初始设置默认关闭按钮
        document.getElementById('modal-close').onclick = defaultModalClose;

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            modal.style.display = 'flex';
            restoreDefaultModalButton(); // 确保显示通知时是默认的"好的"按钮
        }

        // 用于确认操作的模态框
        function showConfirmModal(title, message, onConfirmCallback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            
            modalActions.innerHTML = ''; // 清空所有按钮

            // 添加"取消"按钮
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-action mr-3';
            cancelButton.textContent = '取消';
            cancelButton.onclick = defaultModalClose; // 点击取消关闭模态框并恢复默认按钮
            modalActions.appendChild(cancelButton);

            // 添加"确定"按钮
            const confirmButton = document.createElement('button');
            confirmButton.className = 'btn btn-secondary';
            confirmButton.textContent = '确定';
            confirmButton.onclick = () => {
                defaultModalClose(); // 关闭模态框并恢复默认按钮
                onConfirmCallback(); // 执行确认回调
            };
            modalActions.appendChild(confirmButton);

            modal.style.display = 'flex';
        }

        // 恢复模态框到默认的"好的"按钮状态
        function restoreDefaultModalButton() {
            modalActions.innerHTML = ''; // 清空所有自定义按钮
            const defaultOkButton = document.createElement('button');
            defaultOkButton.id = 'modal-close';
            defaultOkButton.className = 'btn btn-primary';
            defaultOkButton.textContent = '好的';
            defaultOkButton.onclick = defaultModalClose;
            modalActions.appendChild(defaultOkButton);
        }


        // --- 页面导航逻辑 ---
        const pages = document.querySelectorAll('.page');
        function showPage(pageId) {
            pages.forEach(page => page.classList.toggle('active', page.id === pageId));
        }

        function showHomePage() {
            showPage('home-page'); // 显示主页
            // 当返回主页时，清除当前训练的LocalStorage数据，因为它不再是"未完成"的状态
            localStorage.removeItem(`currentSessionData_${currentMuscleGroup}`);
            // 清空动作管理页面的选择
            document.getElementById('manage-muscle-select').value = '';
        }

        async function showTrainingPage(muscle, title) {
            currentMuscleGroup = muscle; // 设置当前肌肉群
            document.getElementById('training-title').textContent = title; // 设置页面标题
            document.getElementById('current-session-container').innerHTML = ''; // 清空当前训练容器
            showPage('training-page'); // 显示训练页面
            
            // 1. 加载可用动作列表
            await loadAvailableExercises();
            // 2. 更新所有动作下拉菜单
            updateAllExerciseDropdowns(); 

            // 3. 尝试从LocalStorage加载上次未完成的会话
            if (!await loadSessionFromLocalStorage()) {
                // 如果LocalStorage中没有数据，则添加一个默认的空训练动作
                addExerciseToSession(); 
            }
            
            // 4. 加载历史记录
            await loadHistory();
        }

        async function showExerciseManagementPage() {
            showPage('exercise-management-page');
            // 每次进入管理页面时，清除上次选择的肌肉群，并重置列表
            document.getElementById('manage-muscle-select').value = '';
            // 确保在重置内容时，loader元素不被移除，或者在需要时重新插入
            const exerciseListContainer = document.getElementById('exercise-list-container');
            const initialContent = '<p class="text-gray-500 text-center py-4" id="no-exercises-message">请选择一个肌肉群。</p><div id="exercise-list-loader" class="hidden justify-center items-center py-8"><div class="loader"></div></div>';
            exerciseListContainer.innerHTML = initialContent; // 重置内容
            // 再次获取loader的引用，确保它是最新的DOM元素
            let exerciseListLoader = document.getElementById('exercise-list-loader');
            if(exerciseListLoader) exerciseListLoader.style.display = 'none'; // 确保初始是隐藏的
        }

        // --- LocalStorage 数据管理 ---
        function saveSessionToLocalStorage() {
            const exerciseBlocks = document.querySelectorAll('#current-session-container .exercise-block');
            const exercisesData = []; // 用于存储要保存的训练数据

            exerciseBlocks.forEach(block => {
                const exerciseSelect = block.querySelector('.exercise-select');
                const exerciseName = exerciseSelect ? exerciseSelect.value : ''; 
                
                // 只有当动作名称有效且不为"添加新动作"时才保存
                if (exerciseName && exerciseName !== 'add_new') {
                    const setsData = [];
                    const setElements = block.querySelectorAll('.set-item');
                    setElements.forEach(setEl => {
                        const weightInput = setEl.querySelector('.set-weight');
                        const repsInput = setEl.querySelector('.set-reps');
                        setsData.push({
                            weight: weightInput ? weightInput.value : '', // 保存当前输入值
                            reps: repsInput ? repsInput.value : ''
                        });
                    });
                    exercisesData.push({ exercise_name: exerciseName, sets_data: setsData });
                }
            });

            // 如果有实际数据（不仅仅是空的默认块），则保存到LocalStorage
            if (exercisesData.length > 0) {
                try {
                    localStorage.setItem(`currentSessionData_${currentMuscleGroup}`, JSON.stringify(exercisesData));
                    // console.log(`Session for ${currentMuscleGroup} saved to LocalStorage.`);
                } catch (e) {
                    console.error("保存到LocalStorage时出错:", e);
                }
            } else {
                // 如果没有有效的训练数据，则清除旧的LocalStorage数据
                localStorage.removeItem(`currentSessionData_${currentMuscleGroup}`);
            }
        }

        async function loadSessionFromLocalStorage() {
            const savedData = localStorage.getItem(`currentSessionData_${currentMuscleGroup}`);
            if (savedData) {
                try {
                    const exercises = JSON.parse(savedData);
                    if (exercises.length > 0) {
                        document.getElementById('current-session-container').innerHTML = ''; // 清空现有内容
                        
                        // 确保availableExercises已加载，以便正确设置下拉菜单的值
                        if (availableExercises.length === 0) {
                            await loadAvailableExercises(); 
                        }

                        exercises.forEach(exercise => {
                            // 为每个动作块生成唯一ID
                            const exerciseId = `ex-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`; 
                            const exerciseDiv = document.createElement('div');
                            exerciseDiv.id = exerciseId;
                            exerciseDiv.className = 'exercise-block bg-gray-800 p-3 rounded-lg border border-gray-600';
                            exerciseDiv.innerHTML = `
                                <div class="flex items-center gap-2">
                                    <select class="exercise-select w-full bg-gray-900 rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" onchange="handleExerciseSelectChange(this); saveSessionToLocalStorage();"></select>
                                    <button onclick="this.parentElement.parentElement.remove(); saveSessionToLocalStorage();" class="text-red-500 hover:text-red-400 p-1 text-2xl font-bold">×</button>
                                </div>
                                <div class="sets-container mt-3 space-y-2"></div>
                                <button onclick="addSetToExercise('${exerciseId}'); saveSessionToLocalStorage();" class="mt-2 w-full text-sm bg-gray-600 hover:bg-gray-500 rounded p-2">+ 添加一组</button>
                            `;
                            document.getElementById('current-session-container').appendChild(exerciseDiv);

                            // 填充动作选择器
                            const selectElement = exerciseDiv.querySelector('.exercise-select');
                            let optionsHtml = availableExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');
                            optionsHtml += '<option value="add_new" class="text-blue-400 font-bold">-- 添加新动作 --</option>';
                            selectElement.innerHTML = optionsHtml;
                            selectElement.value = exercise.exercise_name; // 设置为上次保存的动作名

                            // 填充组数数据
                            const setsContainer = exerciseDiv.querySelector('.sets-container');
                            exercise.sets_data.forEach((set, i) => {
                                const setDiv = document.createElement('div');
                                setDiv.className = 'set-item flex items-center gap-2';
                                setDiv.innerHTML = `
                                    <span class="text-gray-400 w-12 text-sm">第${i + 1}组</span>
                                    <input type="number" placeholder="重量(kg)" value="${set.weight}" class="set-weight w-full bg-gray-900 rounded p-2 text-center focus:outline-none focus:ring-1 focus:ring-blue-400" oninput="saveSessionToLocalStorage()">
                                    <span class="text-gray-500">x</span>
                                    <input type="number" placeholder="次数" value="${set.reps}" class="set-reps w-full bg-gray-900 rounded p-2 text-center focus:outline-none focus:ring-1 focus:ring-blue-400" oninput="saveSessionToLocalStorage()">
                                    <button onclick="this.parentElement.remove(); updateSetNumbers('${exerciseId}'); saveSessionToLocalStorage();" class="text-red-600 p-1 text-lg">×</button>
                                `;
                                setsContainer.appendChild(setDiv);
                            });
                        });
                        return true; // 数据加载成功
                    }
                } catch (e) {
                    console.error("解析LocalStorage数据时出错:", e);
                    localStorage.removeItem(`currentSessionData_${currentMuscleGroup}`); // 清除损坏的数据
                }
            }
            return false; // 没有找到数据或加载失败
        }

        // --- 动作管理 (训练页面和动作管理页面共用) ---
        async function loadAvailableExercises() {
            try {
                const response = await fetch(`${API_BASE_URL}/exercises/${currentMuscleGroup}`);
                if (!response.ok) throw new Error('加载动作列表失败');
                availableExercises = await response.json();
            } catch (error) {
                console.error(error);
                showModal('错误', '加载预设动作列表失败。');
            }
        }

        function updateAllExerciseDropdowns() {
            const selects = document.querySelectorAll('.exercise-select');
            selects.forEach(select => {
                const currentValue = select.value; // 保存当前选中的值
                let optionsHtml = availableExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');
                optionsHtml += '<option value="add_new" class="text-blue-400 font-bold">-- 添加新动作 --</option>';
                select.innerHTML = optionsHtml;
                if (currentValue && availableExercises.includes(currentValue)) {
                    select.value = currentValue; // 恢复之前选中的值
                } else if (availableExercises.length > 0) {
                    select.value = availableExercises[0]; // 默认选择第一个
                } else {
                    select.value = ''; // 如果没有可用动作，则设置为空
                }
            });
        }

        async function handleExerciseSelectChange(selectElement) {
            if (selectElement.value === 'add_new') {
                // 使用 prompt 获取新动作名称，因为这个场景下需要用户输入
                const newExerciseName = prompt(`为【${document.getElementById('training-title').textContent}】添加新动作名称：`);
                if (newExerciseName && newExerciseName.trim() !== '') {
                    try {
                        selectElement.disabled = true; // 禁用选择器，防止重复提交
                        const response = await fetch(`${API_BASE_URL}/exercises`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ muscle_group: currentMuscleGroup, exercise_name: newExerciseName.trim() })
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || '添加新动作失败。');
                        }
                        await loadAvailableExercises(); // 重新加载最新动作列表
                        updateAllExerciseDropdowns(); // 更新所有下拉菜单
                        selectElement.value = newExerciseName.trim(); // 选中新添加的动作
                        saveSessionToLocalStorage(); // 保存到LocalStorage
                        showModal('成功', `动作 "${newExerciseName.trim()}" 已添加！`);
                    } catch (error) {
                        showModal('错误', error.message);
                        selectElement.value = availableExercises[0] || ''; // 失败则恢复默认值
                    } finally {
                        selectElement.disabled = false; // 重新启用选择器
                    }
                } else {
                    selectElement.value = availableExercises[0] || ''; // 用户取消或输入为空，恢复默认值
                }
            }
            saveSessionToLocalStorage(); // 动作选择改变时保存到LocalStorage
        }
        
        // --- 当前训练会话管理 ---
        function addExerciseToSession() {
            const exerciseId = `ex-${Date.now()}`; // 为新动作生成唯一ID
            const exerciseDiv = document.createElement('div');
            exerciseDiv.id = exerciseId;
            exerciseDiv.className = 'exercise-block bg-gray-800 p-3 rounded-lg border border-gray-600';
            exerciseDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <select class="exercise-select w-full bg-gray-900 rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" onchange="handleExerciseSelectChange(this); saveSessionToLocalStorage();"></select>
                    <button onclick="this.parentElement.parentElement.remove(); saveSessionToLocalStorage();" class="text-red-500 hover:text-red-400 p-1 text-2xl font-bold">×</button>
                </div>
                <div class="sets-container mt-3 space-y-2"></div>
                <button onclick="addSetToExercise('${exerciseId}'); saveSessionToLocalStorage();" class="mt-2 w-full text-sm bg-gray-600 hover:bg-gray-500 rounded p-2">+ 添加一组</button>
            `;
            document.getElementById('current-session-container').appendChild(exerciseDiv);
            addSetToExercise(exerciseId); // 自动为新动作添加第一组
            updateAllExerciseDropdowns(); // 更新新添加的下拉菜单
            saveSessionToLocalStorage(); // 添加新动作块后保存
        }

        function addSetToExercise(exerciseId) {
            const setsContainer = document.querySelector(`#${exerciseId} .sets-container`);
            const setCount = setsContainer.children.length + 1; // 计算当前是第几组
            
            // 获取上一组的重量作为默认值
            let defaultWeight = '';
            // 如果不是第一组，尝试获取上一组的重量
            if (setCount > 1) {
                const previousSetWeightInput = setsContainer.querySelector(`.set-item:last-child .set-weight`);
                if (previousSetWeightInput) {
                    defaultWeight = previousSetWeightInput.value;
                }
            }

            const setDiv = document.createElement('div');
            setDiv.className = 'set-item flex items-center gap-2';
            setDiv.innerHTML = `
                <span class="text-gray-400 w-12 text-sm">第${setCount}组</span>
                <input type="number" placeholder="重量(kg)" value="${defaultWeight}" class="set-weight w-full bg-gray-900 rounded p-2 text-center focus:outline-none focus:ring-1 focus:ring-blue-400" oninput="saveSessionToLocalStorage()">
                <span class="text-gray-500">x</span>
                <input type="number" placeholder="次数" class="set-reps w-full bg-gray-900 rounded p-2 text-center focus:outline-none focus:ring-1 focus:ring-blue-400" oninput="saveSessionToLocalStorage()">
                <button onclick="this.parentElement.remove(); updateSetNumbers('${exerciseId}'); saveSessionToLocalStorage();" class="text-red-600 p-1 text-lg">×</button>
            `;
            setsContainer.appendChild(setDiv);
            saveSessionToLocalStorage(); // 添加新组后保存
        }
        
        function updateSetNumbers(exerciseId) {
            const setsContainer = document.querySelector(`#${exerciseId} .sets-container`);
            const allSetSpans = setsContainer.querySelectorAll('.set-item span:first-child');
            allSetSpans.forEach((span, i) => {
                span.textContent = `第${i + 1}组`; // 更新组数显示
            });
        }

        async function saveSession() {
            const saveButton = document.getElementById('save-session-button');
            saveButton.disabled = true; // Disable the button immediately
            saveButton.textContent = '保存中...'; // Change button text to indicate loading state
            saveButton.classList.remove('bg-green-600', 'hover:bg-green-500');
            saveButton.classList.add('bg-gray-500'); // Optional: change color to gray

            const exerciseBlocks = document.querySelectorAll('.exercise-block');
            if (exerciseBlocks.length === 0) {
                showModal('提示', '请至少添加一个训练动作。');
                saveButton.disabled = false; // Re-enable button
                saveButton.textContent = '✓ 完成并保存本次训练'; // Restore button text
                saveButton.classList.remove('bg-gray-500');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                return;
            }

            const exercisesData = [];
            for (const block of exerciseBlocks) {
                const exerciseName = block.querySelector('.exercise-select').value;
                if (!exerciseName || exerciseName === 'add_new') {
                    showModal('错误', '请为所有动作选择一个有效的名称。');
                    saveButton.disabled = false; // Re-enable button
                    saveButton.textContent = '✓ 完成并保存本次训练'; // Restore button text
                    saveButton.classList.remove('bg-gray-500');
                    saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                    return;
                }

                const setsData = [];
                const setElements = block.querySelectorAll('.set-item');
                let lastValidWeight = ''; // 用于存储上一组的有效重量

                for (let i = 0; i < setElements.length; i++) {
                    const weightInput = setElements[i].querySelector('.set-weight');
                    const repsInput = setElements[i].querySelector('.set-reps');
                    let weight = weightInput.value.trim();
                    const reps = repsInput.value.trim();

                    if (i === 0 && !weight) { 
                        showModal('错误', `动作 "${exerciseName}" 的第一组重量是必填项！`); 
                        saveButton.disabled = false; // Re-enable button
                        saveButton.textContent = '✓ 完成并保存本次训练'; // Restore button text
                        saveButton.classList.remove('bg-gray-500');
                        saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                        return; 
                    }
                    if (!reps) { 
                        showModal('错误', `动作 "${exerciseName}" 的第 ${i+1} 组次数不能为空！`); 
                        saveButton.disabled = false; // Re-enable button
                        saveButton.textContent = '✓ 完成并保存本次训练'; // Restore button text
                        saveButton.classList.remove('bg-gray-500');
                        saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                        return; 
                    }
                    
                    // 如果当前组没有输入重量，则使用上一组的有效重量
                    if (!weight) {
                        weight = lastValidWeight; 
                    } else {
                        lastValidWeight = weight; // 更新上一组的有效重量
                    }

                    setsData.push({ weight: parseFloat(weight), reps: parseInt(reps) });
                }
                
                if (setsData.length > 0) {
                    exercisesData.push({ exercise_name: exerciseName, sets_data: setsData });
                }
            }

            if (exercisesData.length === 0) {
                showModal('提示', '没有有效的训练数据可以保存。');
                saveButton.disabled = false; // Re-enable button
                saveButton.textContent = '✓ 完成并保存本次训练'; // Restore button text
                saveButton.classList.remove('bg-gray-500');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
                return;
            }

            // Set up a timeout for the fetch request
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 5000); // 5-second timeout

            try {
                const response = await fetch(`${API_BASE_URL}/session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ muscle_group: currentMuscleGroup, exercises_data: exercisesData }),
                    signal: controller.signal // Associate the abort controller with the fetch request
                });
                clearTimeout(id); // Clear the timeout if the request completes in time

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '保存失败');
                }
                
                showModal('成功', '训练已保存！');
                document.getElementById('current-session-container').innerHTML = ''; // 清空当前训练界面
                addExerciseToSession(); // 添加一个默认的空动作块
                localStorage.removeItem(`currentSessionData_${currentMuscleGroup}`); // **重要：成功保存后清除LocalStorage数据**
                await loadHistory(); // 重新加载历史记录
            } catch (error) {
                if (error.name === 'AbortError') {
                    showModal('保存失败', '请求超时，请检查网络或稍后重试。');
                } else {
                    showModal('保存失败', error.message);
                }
            } finally {
                saveButton.disabled = false; // Re-enable button
                saveButton.textContent = '✓ 完成并保存本次训练'; // Restore button text
                saveButton.classList.remove('bg-gray-500');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-500');
            }
        }

        // --- 历史记录管理 ---
        async function loadHistory() {
            const historyContainer = document.getElementById('history-container');
            let loader = document.getElementById('loader'); // 使用 let 声明

            // 防御性检查：如果 loader 元素不存在，则重新创建并添加到 DOM 中
            if (!loader) {
                console.warn("Loader element not found, recreating it for history container."); // 添加警告日志
                loader = document.createElement('div');
                loader.id = 'loader';
                loader.className = 'hidden justify-center items-center py-8';
                loader.innerHTML = '<div class="loader"></div>';
                historyContainer.appendChild(loader); // 将 loader 添加回 historyContainer
            }

            // 1. 清除所有之前的训练会话条目（历史记录块）
            historyContainer.querySelectorAll('.bg-gray-700\\/50').forEach(el => el.remove());

            // 2. 清除之前可能存在的"暂无历史记录"消息
            const noHistoryMessage = document.getElementById('no-history-message');
            if (noHistoryMessage) {
                noHistoryMessage.remove();
            }

            // 3. 清除之前可能存在的"加载失败"消息
            const loadErrorMessage = document.getElementById('load-error-message');
            if (loadErrorMessage) {
                loadErrorMessage.remove();
            }

            // 在尝试访问 style 属性之前，再次确认 loader 不为 null
            if (loader) {
                console.log("Loader element for history before setting style:", loader); // 添加调试日志
                loader.style.display = 'flex'; // 显示加载动画
            } else {
                console.error("Critical error: History loader element is null even after recreation attempt.");
                // 此时可以考虑直接返回或显示一个无法加载的错误信息
                historyContainer.insertAdjacentHTML('beforeend', `<p class="text-red-400 text-center py-4">历史记录加载器初始化失败，请刷新页面。</p>`);
                return; // 阻止后续操作
            }

            try {
                const response = await fetch(`${API_BASE_URL}/history/${currentMuscleGroup}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '加载失败');
                }
                const sessions = await response.json();

                if (loader) loader.style.display = 'none'; // 隐藏加载动画
                else console.warn("History loader element became null while fetching data.");


                if (sessions.length === 0) {
                    // 如果没有历史记录，则添加"暂无历史记录"消息，并给它一个ID
                    historyContainer.insertAdjacentHTML('beforeend', '<p id="no-history-message" class="text-gray-500 text-center py-4">暂无历史记录。</p>');
                    return;
                }

                let html = '';
                sessions.forEach(session => {
                    html += `
                        <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600/50">
                            <div class="flex justify-between items-center border-b border-gray-600 pb-2 mb-3">
                                <h3 class="font-bold text-lg text-blue-300">${session.session_date}</h3>
                                <button onclick="deleteSession(${session.session_id})" class="text-gray-500 hover:text-red-400 text-xl">🗑️</button>
                            </div>
                            <div class="space-y-3">
                    `;
                    session.exercises_data.forEach(workout => {
                        html += `
                                    <div>
                                        <p class="font-semibold text-white">${workout.exercise_name}</p>
                                        <div class="text-sm text-gray-300 pl-4 border-l-2 border-gray-600 mt-1 ml-1">
                                            ${workout.sets_data.map((s, i) => `<span>第${i+1}组: ${s.weight}kg &times; ${s.reps}次</span>`).join('<br>')}
                                        </div>
                                    </div>
                        `;
                    });
                    html += `</div></div>`;
                });
                historyContainer.insertAdjacentHTML('beforeend', html); // 将新历史记录添加到容器
            } catch (error) {
                if (loader) loader.style.display = 'none'; // 隐藏加载动画
                else console.warn("History loader element was null during error handling.");
                // 在加载失败时，也给这个消息一个ID
                historyContainer.insertAdjacentHTML('beforeend', `<p id="load-error-message" class="text-red-400 text-center py-4">加载失败: ${error.message}</p>`);
            }
        }
        
        async function deleteSession(sessionId) {
            // 使用自定义确认模态框替代原生的 confirm()
            showConfirmModal('确认删除', '确定要删除这次训练记录吗？此操作无法撤销。', async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/session/${sessionId}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '删除失败');
                    }
                    showModal('成功', '训练记录已删除。');
                    await loadHistory(); // 重新加载历史记录以更新界面
                } catch (error) {
                    showModal('删除失败', error.message);
                }
            });
        }

        // --- 动作管理页面功能 ---
        async function loadExercisesForManagement(muscle) {
            currentManageMuscleGroup = muscle;
            const exerciseListContainer = document.getElementById('exercise-list-container');
            let exerciseListLoader = document.getElementById('exercise-list-loader'); // 使用 let 声明

            // 防御性检查：如果 loader 元素不存在，则重新创建并添加到 DOM 中
            if (!exerciseListLoader) {
                console.warn("Exercise list loader element not found, recreating it for management container."); // 添加警告日志
                exerciseListLoader = document.createElement('div');
                exerciseListLoader.id = 'exercise-list-loader';
                exerciseListLoader.className = 'hidden justify-center items-center py-8';
                exerciseListLoader.innerHTML = '<div class="loader"></div>';
                exerciseListContainer.appendChild(exerciseListLoader); // 将 loader 添加回 exerciseListContainer
            }

            // 1. 清除所有之前的动作列表项（class="flex items-center justify-between"）
            exerciseListContainer.querySelectorAll('.flex.items-center.justify-between').forEach(el => el.remove());

            // 2. 清除之前可能存在的"请选择一个肌肉群"或"该肌肉群暂无动作"消息
            const noExercisesMessage = document.getElementById('no-exercises-message');
            if (noExercisesMessage) {
                noExercisesMessage.remove();
            }
            // 3. 清除之前可能存在的加载失败消息 (如果管理页面也有)
            const managementLoadErrorMessage = document.getElementById('management-load-error-message');
            if (managementLoadErrorMessage) {
                managementLoadErrorMessage.remove();
            }

            if (!muscle) {
                exerciseListContainer.insertAdjacentHTML('beforeend', '<p class="text-gray-500 text-center py-4" id="no-exercises-message">请选择一个肌肉群。</p>');
                if (exerciseListLoader) exerciseListLoader.style.display = 'none'; // Hide loader if no muscle selected
                return;
            }

            // 在尝试访问 style 属性之前，再次确认 loader 不为 null
            if (exerciseListLoader) {
                console.log("Loader element for management before setting style:", exerciseListLoader); // 添加调试日志
                exerciseListLoader.style.display = 'flex'; // 显示加载动画
            } else {
                console.error("Critical error: Management loader element is null even after recreation attempt.");
                exerciseListContainer.insertAdjacentHTML('beforeend', `<p class="text-red-400 text-center py-4">动作管理加载器初始化失败，请刷新页面。</p>`);
                return; // 阻止后续操作
            }

            try {
                const response = await fetch(`${API_BASE_URL}/exercises/${muscle}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '加载动作列表失败');
                }
                const exercises = await response.json();

                if (exerciseListLoader) exerciseListLoader.style.display = 'none'; // 隐藏加载动画
                else console.warn("Management loader element became null while fetching data.");


                if (exercises.length === 0) {
                    exerciseListContainer.insertAdjacentHTML('beforeend', '<p class="text-gray-500 text-center py-4" id="no-exercises-message">该肌肉群暂无动作，请添加。</p>');
                    return;
                }

                let html = '';
                exercises.forEach(ex => {
                    html += `
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg border border-gray-600">
                            <span class="text-white text-lg flex-grow mr-2">${ex}</span>
                            <div class="flex gap-2">
                                <button onclick="editExercise('${muscle}', '${ex}')" class="bg-blue-600 hover:bg-blue-500 text-white py-1 px-3 rounded text-sm">编辑</button>
                                <button onclick="deleteExerciseFromManagement('${muscle}', '${ex}')" class="bg-red-600 hover:bg-red-500 text-white py-1 px-3 rounded text-sm">删除</button>
                            </div>
                        </div>
                    `;
                });
                exerciseListContainer.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                if (exerciseListLoader) exerciseListLoader.style.display = 'none';
                else console.warn("Management loader element was null during error handling.");
                exerciseListContainer.insertAdjacentHTML('beforeend', `<p id="management-load-error-message" class="text-red-400 text-center py-4">加载动作失败: ${error.message}</p>`);
            }
        }

        async function addNewExercise() {
            const muscle = document.getElementById('manage-muscle-select').value;
            const newExerciseInput = document.getElementById('new-exercise-input');
            const newExerciseName = newExerciseInput.value.trim();

            if (!muscle) {
                showModal('提示', '请先选择一个肌肉群。');
                return;
            }
            if (!newExerciseName) {
                showModal('提示', '请输入新动作名称。');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/exercises`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ muscle_group: muscle, exercise_name: newExerciseName })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '添加失败');
                }
                showModal('成功', `动作 "${newExerciseName}" 已添加。`);
                newExerciseInput.value = ''; // 清空输入框
                await loadExercisesForManagement(muscle); // 重新加载列表
                // 刷新训练页面的可用动作列表
                currentMuscleGroup = muscle; // 临时设置，确保loadAvailableExercises加载正确
                await loadAvailableExercises(); 
                updateAllExerciseDropdowns();
            } catch (error) {
                showModal('添加失败', error.message);
            }
        }

        async function editExercise(muscle, oldName) {
            // 使用 prompt 获取新动作名称
            const newName = prompt(`编辑动作 "${oldName}" 的名称：`, oldName);
            if (newName === null || newName.trim() === '' || newName.trim() === oldName) {
                // 用户取消或输入为空或名称未改变
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/exercises`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ muscle_group: muscle, old_exercise_name: oldName, new_exercise_name: newName.trim() })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '编辑失败');
                }
                showModal('成功', `动作 "${oldName}" 已更新为 "${newName.trim()}"。`);
                await loadExercisesForManagement(muscle); // 重新加载列表
                // 刷新训练页面的可用动作列表
                currentMuscleGroup = muscle; // 临时设置，确保loadAvailableExercises加载正确
                await loadAvailableExercises(); 
                updateAllExerciseDropdowns();
            } catch (error) {
                showModal('编辑失败', error.message);
            }
        }

        async function deleteExerciseFromManagement(muscle, exerciseName) {
            // 使用自定义确认模态框替代原生的 confirm()
            showConfirmModal('确认删除', `确定要删除动作 "${exerciseName}" 吗？此操作无法撤销。`, async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/exercises`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ muscle_group: muscle, exercise_name: exerciseName })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '删除失败');
                    }
                    showModal('成功', `动作 "${exerciseName}" 已删除。`);
                    await loadExercisesForManagement(muscle); // 重新加载列表
                    // 刷新训练页面的可用动作列表
                    currentMuscleGroup = muscle; // 临时设置，确保loadAvailableExercises加载正确
                    await loadAvailableExercises(); 
                    updateAllExerciseDropdowns();
                } catch (error) {
                    showModal('删除失败', error.message);
                }
            });
        }

        // --- 页面初始化 ---
        document.addEventListener('DOMContentLoaded', () => showHomePage());
    </script>
</body>
</html>